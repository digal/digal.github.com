
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Лошоть и байты</title>
  <meta name="author" content="Yuri Buyanov">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://digal.github.com/index.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Лошоть и байты" type="application/atom+xml"/>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-25244055-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Лошоть и байты</a></h1>
  
    <h2>The blog</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:digal.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/25/squeryl/">Squeryl: основы</a></h1>
    
    
      <p class="meta">




<time datetime="2011-09-25 21:46:00 +0400" pubdate  updated >Sep 25<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Этим и следующим постом (который, надеюсь, будет вот совсем скоро) я хочу познакомить вас с замечательной ORM-библиотекой для scala, которую сейчас использую в одном из рабочих проектов. Не надо пугаться аббревиатуры ORM: возожности маппинга к объектам здесь принципиально реализованы на совсем базовом уровне, а вот симпатичный DSL для запросов стоит того, чтобы на него взглянуть.</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2011/09/25/squeryl/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/07/fixtures/">Fixtures</a></h1>
    
    
      <p class="meta">




<time datetime="2011-09-07 09:46:00 +0400" pubdate  updated >Sep 7<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>В предыдущем посте я рассказывал об исполняемых конфигах ostrich и не упомянул особых их достоинств, кроме type safety и удобства работы с настройками со стороны приложения. На прошлой неделе я наткнулся на ещё один хороший юзкейс для таких конфигов.</p>

<p>Предположим, мы развёртываем наше приложение в разных окружениях (dev, test, prod), и в некоторых из них было бы здорово иметь в базе некоторые начальные данные для упрощения, например, процесса тестирования. Есть несколько достаточно тривиальных, но не очень удобных способов решения этой проблемы, особенно если загрузка этих начальных данных - часть автоматического развёртывания через CI-сервер. В скриптовых языках, где исполняемые файлы настроек - норма, такие данные (называемые fixtures) часто делаются частью конфига.</p>

<p>С ostrich реализация такой штуки становится делом буквально нескольких строк кода:</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2011/09/07/fixtures/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/05/no-newsletters/">Пример хорошего UX</a></h1>
    
    
      <p class="meta">




<time datetime="2011-09-05 12:15:00 +0400" pubdate  updated >Sep 5<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Регистрируясь на <a href="http://coderwall.com/">coderwall</a> (по наводке <a href="http://twitter.com/shaman_sir">@shaman_sir</a>) увидел замечательный пример той самой области UX, не относящейся ни к дизайну ни к юзабилити. Ничего супер-пупер-грандиозного, просто под полем для ввода электропочты в форме регистрации - небольшое примечание.</p>

<blockquote><p>No spam, always private. We respect the sanctity of your email and share your dislike for spam and unnecessarily frequent newsletters. If you&#8217;re interested in future coderwall news, we suggest you follow us on twitter.</p></blockquote>


<p>Не знаю как вам, а мне безумно приятно видеть сервис, уважающий моё личное информационное пространство и максимально ненавязчиво предлагающий просто подписаться на твиттер, если уж мне так хочется читать относящиеся к нему новости. По-моему, это гораздо лучше обычной галочки &#8220;присылать/не присылать новости&#8221;: в случае с твиттером заранее знаешь, что отписаться при желании можно будет в любой момент и одной кнопкой. Я уже не говорю о случаях, когда пользователю вообще не оставляют никакого выбора.</p>

<p>В общем, я кажется нашёл главный секрет хорошего UX: &#8220;Уважай своего пользователя&#8221;. Просто ведь, правда?</p>
</div>
  <footer>
    <a rel="full-article" href="/blog/2011/09/05/no-newsletters/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/29/scala-irl-2-ostrich/">Scala IRL. Часть 2: Готовим Домашнего Страуса</a></h1>
    
    
      <p class="meta">




<time datetime="2011-08-29 22:28:00 +0400" pubdate  updated >Aug 29<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>В предыдущем посте я мельком упомянул библиотеку ostrich в качестве инструмента для загрузки конфигов, в этом же постараюсь сделать более подробный обзор. Итак, <a href="github.com/twitter/ostrich">ostrich</a> - это внутренняя библиотека от разработчиков &#8220;твиттера&#8221;, используемая в его компонентах. Несмотря на фичастость и навороченность, местами довольно-таки заметен её стиль, как библиотеки написанной в первую очередь &#8220;для себя&#8221;.</p>

<p>Оstrich выполняет следующие задачи:</p>

<ul>
<li>загрузка и парсинг typesafe-конфигов (проще, говоря, конфигов в виде scala-кода)</li>
<li>сбор рантайм-статистики и разнообразных метрик</li>
<li>управление сервисами внутри процесса (запуск/остановка)</li>
<li>предоставление простенького, но расширяемого администраторского интерфейса через http/socket</li>
</ul>


<p>В этом посте я опишу работу с конфигами, а остальные возможности попробую раскрыть в последующих постах.</p>

<h2>Страус и конфиги</h2>

<p>Итак, ostrich предлагает использовать в качестве конфигов не просто структурированные текстовые файлы (json/xml/properties), а scala-код. Такой подход требует компиляции конфига при загрузке, но имеет ряд серьёзных преимуществ:</p>

<ul>
<li>типизация. Отпадает необходимость проверять и приводить значения из конфиг-файла к нужным типам</li>
<li>возможность писать произвольный код в конфигах, помимо простых значений. Например, использовать текущую дату в произвольном формате в имени лог-файла, или получить значения каких-то параметров из базы или стороннего сервиса. По сути, конфиг-файл становится тем, что называется extension point.</li>
<li>становятся ненужными отдельные классы, инкапсулирующие конфигурацию различных компонентов программы, или, по крайней мере, упрощается их создание.</li>
</ul>


<p>Для начала, нам нужно создать родительский класс для настроек. Чаще всего удобно сделать его же конфигом по умолчанию. Предположим, мы хотим сконфигурировать небольшое серверное приложение. Для этого ostrich предоставляет класс ServerConfig (являющийся наследником Config, предоставляющего базовые функции такие как компиляция, валидация и обязательные/необязательные поля).</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">import</span> <span class="nn">com.twitter.ostrich.admin._</span>
</div><div class='line'><span class="k">import</span> <span class="nn">com.twitter.ostrich.admin.config._</span>
</div><div class='line'><span class="k">import</span> <span class="nn">com.twitter.logging.config._</span>
</div><div class='line'><span class="k">import</span> <span class="nn">com.twitter.logging.Level</span>
</div><div class='line'>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">MyServerConfig</span> <span class="k">extends</span> <span class="nc">ServerConfig</span><span class="o">[</span><span class="kt">MyServer</span><span class="o">]</span> <span class="o">{</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1">//ServerConfig, в отличие от просто Config, должен определить </span>
</div><div class='line'>  <span class="c1">//метод Apply, для создания инстанса сервера</span>
</div><div class='line'>  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">runtime</span><span class="k">:</span> <span class="kt">RuntimeEnvironment</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</div><div class='line'>    <span class="k">new</span> <span class="nc">MyServer</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</div><div class='line'>  <span class="o">}</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">var</span> <span class="n">port</span> <span class="k">=</span> <span class="mi">1234</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">workersNum</span> <span class="k">=</span> <span class="mi">10</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">baseUrl</span> <span class="k">=</span> <span class="s">&quot;http://localhost:%s&quot;</span> <span class="n">format</span> <span class="n">port</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">dbConfig</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DBConfig</span>
</div><div class='line'><span class="o">}</span>
</div><div class='line'>
</div><div class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">DBConfig</span><span class="o">(</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">driver</span> <span class="k">=</span> <span class="s">&quot;org.h2.Driver&quot;</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;jdbc:h2:mem:&quot;</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">create</span> <span class="k">=</span> <span class="kc">true</span>
</div><div class='line'><span class="o">)</span>
</div></code></pre></td></tr></table></div>

<p>Надо заметить, что мы используем в этом конфиге изменяемые переменные (<code>var</code>). В Scala это зачастую является признаком недостаточно функционального (декларативного) стиля, однако в данном случае это позволит писать лаконичные конфиги, выставляя значение полей простым присваиванием. Кроме того, этот же стиль используется при объявлении уже имеющихся в ServerConfig значений.</p>

<p>Итак, теперь наш конфиг для, например, тестового сервера, может выглядеть так:</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">new</span> <span class="nc">MyServerConfig</span> <span class="o">{</span>
</div><div class='line'>  <span class="n">port</span> <span class="k">=</span> <span class="mi">80</span>
</div><div class='line'>  <span class="n">baseUrl</span> <span class="k">=</span> <span class="s">&quot;http://test.myserver.com&quot;</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">dbConfig</span><span class="o">.</span><span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;jdbc:h2:/tmp/test.db;AUTO_SERVER=TRUE&quot;</span>
</div><div class='line'><span class="o">}</span>
</div></code></pre></td></tr></table></div>

<p>Вполне лаконично, и ничуть не хуже .properties и уж тем более XML-файла. Можем сохранить его под именем <code>test.scala</code>, тогда наш сервер мы сможем запускать как</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='bash'><div class='line'>java -jar my-server.jar -f ./test.scala
</div></code></pre></td></tr></table></div>

<h2>Загрузка</h2>

<p>Теперь, наш файл настроек надо загрузить и использовать по назначению. Делать это логичнее всего поближе к точке входа, например в <code>main</code>. Путь к файлу можно передать с параметром <code>-f</code> при запуске приложения, а если его нет, то ostrich попытается найти его сам. Определение местоположения конфиг-файла - это то самое место, где становится видно, что проект делался для себя: ostrich ищет его в довольно специфических местах, пытаясь сначала выяснить имя jar-файла. Поэтому, проще всего всегда передавать путь к конфигу через <code>-f</code> плюс явно указать конфиг по умолчанию. Поскольку конфиг по умолчанию является обычным scala-классом, можно просто создать его инстанс в коде. Вот как выглядит загрузка и использование конфига у меня:</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">object</span> <span class="nc">MyServer</span> <span class="o">{</span>
</div><div class='line'>  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</div><div class='line'>    <span class="k">val</span> <span class="n">runtime</span> <span class="k">=</span> <span class="nc">RuntimeEnvironment</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>
</div><div class='line'>    <span class="k">val</span> <span class="n">server</span> <span class="k">=</span>
</div><div class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">configFile</span><span class="o">.</span><span class="n">exists</span><span class="o">)</span> <span class="c1">//если ostrich нашёл конфиг-файл </span>
</div><div class='line'>        <span class="n">runtime</span><span class="o">.</span><span class="n">loadRuntimeConfig</span><span class="o">[</span><span class="kt">Server</span><span class="o">]()</span>
</div><div class='line'>      <span class="k">else</span> <span class="c1">//default</span>
</div><div class='line'>        <span class="o">(</span><span class="k">new</span> <span class="nc">MyServerConfig</span><span class="o">)()(</span><span class="n">runtime</span><span class="o">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</div><div class='line'>  <span class="o">}</span>
</div><div class='line'><span class="o">}</span>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">MyServer</span><span class="o">(</span><span class="k">val</span> <span class="n">config</span><span class="k">:</span> <span class="kt">MyServerConfig</span><span class="o">)</span>
</div><div class='line'><span class="o">{</span>
</div><div class='line'>  <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DB</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">dbConfig</span><span class="o">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="n">start</span><span class="o">()</span> <span class="o">{</span>
</div><div class='line'>    <span class="c1">//...</span>
</div><div class='line'>  <span class="o">}</span>
</div><div class='line'><span class="o">}</span>
</div></code></pre></td></tr></table></div>

<p>Обратите внимание на строчку <code>(new MyServerConfig)()(runtime)</code>: сначала мы вызываем метод apply без параметров, а потом вызываем полученную функцию с параметром типа RuntimeEnvironment. При необходимости, этот способ можно расширить для загрузки различных конфигов по умолчанию, например в зависимости от <code>run.mode</code> в lift.</p>

<p>Я не использовал возможность ostrich объявлять поля как обязательные/опциональные, но промолчать о ней будет, наверное, неправильно. В приведённой к классу Config документации всё довольно просто:</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="c1">//необязательное поле</span>
</div><div class='line'><span class="k">var</span> <span class="n">something</span> <span class="k">=</span> <span class="n">optional</span><span class="o">[</span><span class="kt">Duration</span><span class="o">]</span>
</div><div class='line'>
</div><div class='line'><span class="c1">//обязательное поле</span>
</div><div class='line'><span class="k">var</span> <span class="n">level</span> <span class="k">=</span> <span class="n">required</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</div><div class='line'>
</div><div class='line'><span class="c1">//вычисляемое (lazily evaluated!) поле</span>
</div><div class='line'><span class="k">var</span> <span class="n">nextLevel</span> <span class="k">=</span> <span class="n">computed</span><span class="o">(</span><span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
</div></code></pre></td></tr></table></div>

<h2>Конфигурация компонентов</h2>

<p>В вышеприведённом примере мы вынесли настройку базы данных в отдельный класс DBConfig. Иногда, со стороны приложения бывает удобно вынести конфигурацию в отдельный класс, но усложнять структуру конфиг-файла не хочется. Хорошим примером является случай, когда конфигурируемый компонент находится в другом (под)проекте. В этом случае, конфиг можно объявить трейтом и подмешать его в основной конфиг</p>

<p>Представим, что мы хотим добавить в наш север небольшой внутренний почтовый сервис для отсылки писем пользователям.</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">trait</span> <span class="nc">MailConfig</span> <span class="o">{</span>
</div><div class='line'>  <span class="k">def</span> <span class="n">smtpServer</span><span class="k">:</span>  <span class="kt">String</span>
</div><div class='line'>  <span class="k">def</span> <span class="n">smtpPort</span><span class="k">:</span>    <span class="kt">String</span>
</div><div class='line'>  <span class="k">def</span> <span class="n">fromAddress</span><span class="k">:</span> <span class="kt">String</span>
</div><div class='line'><span class="o">}</span>
</div><div class='line'>
</div><div class='line'><span class="k">class</span> <span class="nc">MailManager</span><span class="o">(</span><span class="k">val</span> <span class="n">config</span><span class="k">:</span> <span class="kt">MailConfig</span><span class="o">)</span> <span class="o">{</span>
</div><div class='line'>  <span class="o">...</span>
</div><div class='line'><span class="o">}</span>
</div></code></pre></td></tr></table></div>

<p>Теперь мы просто подмешиваем трейт в наш основной конфиг, перегружая его методы нашими <code>var</code>ами:</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">class</span> <span class="nc">MyServerConfig</span>
</div><div class='line'><span class="k">extends</span> <span class="nc">ServerConfig</span><span class="o">[</span><span class="kt">MyServer</span><span class="o">]</span>
</div><div class='line'><span class="k">with</span> <span class="nc">MailConfig</span>
</div><div class='line'><span class="o">{</span>
</div><div class='line'>  <span class="o">...</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">var</span> <span class="n">smtpServer</span> <span class="k">=</span> <span class="n">required</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">smtpPort</span> <span class="k">=</span> <span class="mi">24</span>
</div><div class='line'>  <span class="k">var</span> <span class="n">fromAddress</span> <span class="k">=</span> <span class="s">&quot;noreply@domain.com&quot;</span>
</div><div class='line'><span class="o">}</span>
</div></code></pre></td></tr></table></div>

<p>В нашем конфиг-файле (<code>test.scala</code>) эти поля будут работать точно так же как и все остальные. При инстанциировании менеджера можно просто передать ему общий конфиг:</p>

<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
</pre></td><td class='code' width='100%'><pre><code class='scala'><div class='line'><span class="k">class</span> <span class="nc">MyServer</span><span class="o">(</span><span class="k">val</span> <span class="n">config</span><span class="k">:</span> <span class="kt">MyServerConfig</span><span class="o">)</span>
</div><div class='line'><span class="o">{</span>
</div><div class='line'>  <span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DB</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="n">dbConfig</span><span class="o">)</span>
</div><div class='line'>  <span class="k">val</span> <span class="n">mailer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MailManager</span><span class="o">(</span><span class="n">config</span><span class="o">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="o">...</span>
</div><div class='line'><span class="o">}</span>
</div></code></pre></td></tr></table></div>

<p>Также, в отдельный трейт можно вынести готовые значения для настроек если они представляют собой что-то более сложное чем простые значения.</p>

<p>Вот собственно и всё что я хотел рассказать об использовании ostrich для конфигурирования. Я намеренно не стал рассматривать имеющиеся в ServerConfig поля для настройки логгинга, статистики и админки. Мы вернёмся к ним попозже, когда я буду рассказывать о соответствующих фичах &#8220;страуса&#8221;.</p>
</div>
  <footer>
    <a rel="full-article" href="/blog/2011/08/29/scala-irl-2-ostrich/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/23/scala-irl-1-configs/">Scala IRL. Часть 1: конфиги.</a></h1>
    
    
      <p class="meta">




<time datetime="2011-08-23 22:40:00 +0400" pubdate  updated >Aug 23<span>rd</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Для Scala, как для языка довольно молодого, пока ещё нет (а может уже и не будет) единого стандарта для такой обыденной вещи как конфиг-файлы. Вариантов не так уж много и в этом посте я хочу сделать небольшой обзор тех, которые мне так или иначе довелось использовать.</p>

<h3>.properties</h3>

<p>Текстовые и XML файлы, хранящие пары &#8220;ключ-значение&#8221;. Вполне подходят для конфигурирования большинства проектов, а в стандартной библиотеке JRE, есть средства для работы с ними. Что касается поддержки со стороны Scala, в пакете <code>scala.collection</code> есть объекты <code>JavaConverters</code> и <code>JavaConversions</code>, предоставляющие implicit методы для конвертации объектов класса <code>Properties</code> в <code>mutable.Map[String, String]</code>.</p>

<p>Эти файлы часто используются не столько для хранения конфигов, сколько для локализации. Тут нельзя промолчать об одной их особенности, о которой, наверное, знает каждый Java-программист, но которая всегда меня изумляла: в платформе, где Unicode является основной кодировкой для работы со строками, для хранения локализованных строк предлагается формат, <strong>не поддерживаюший unicode</strong>. Файлы предлагается сначала писать в unicode, а потом конвертировать в странный и уродливый формат утилитой native2ascii. Ну не отвратительно ли?</p>

<p>Эти же файлы использует фреймворк Lift (с расширением .props), добавляя к ним <a href="http://www.assembla.com/wiki/show/liftweb/Run_Modes">замысловатый механизм</a> выбора нужного файла в зависимости от режима работы (run mode) и окружения.</p>

<h3>XML и JSON</h3>

<p>Здесь всё понятно: стандартных библиотек целая куча, и старые явовские, и специально сделанные для Scala с вкусностями типа XPath-подобных DSL. Такие конфиги имеют привычку разрастаться до неприличных размеров, а JSON ещё и не умеет удобно работать с длинными и многострочными значениями и не имеет констукции для комментариев. Впрочем, можно просто использовать для этой цели обычные поля, которые при чтении конфига будут игнорироваться.</p>

<h3>configgy</h3>

<p>configgy - замечательная Scala-библиотека, выполняющая сразу две задачи: работа с конфиг-файлами и удобный логгинг. Эти задачи практически никак не связаны между собой (за исключением того, что логгинг тоже надо конфигурировать), но это именно те две задачи, которые требуется решать в практически любом проекте больше сотни строк.</p>

<p>Configgy поддерживает несколько форматов для конфигов, как линейный, так и со вложенными блоками, типа такого:</p>

<pre><code># JDBC parameters
jdbc {
    driver = "com.mysql.jdbc.Driver"
    uri = "jdbc:mysql://localhost:3306/test?characterEncoding=UTF8"
    limit = 5000 # Batch size for selects
}

#logging parameters, see configgy readme for details
log {
    filename = "debug.log"
    level = "debug"
    utc = false
    console = false
}
</code></pre>

<p>Логгинг автоматически подхватывает параметры из секции log при чтении конфига, что очень удобно - вся обычная рутина с конфигурированием сводится практически к одной строчке.</p>

<h3>Ostrich</h3>

<p>Когда мы собрались прицепить configgy к одному из очередных наших проектов, то обнаружили (на <a href="https://github.com/robey/configgy">страничке</a> проекта на github), что проект теперь deprecated (хотя и будет пока поддерживаться в каком-то виде) и вместо него предлагается использовать Scala-библиотеки от twitter. Для логгинга - util-logging из набора <a href="https://github.com/twitter/util">Util</a>, который помимо лог-файлов поддерживает <a href="https://github.com/facebook/scribe">Scribe</a> и Syslog, для конфигурирования - <a href="https://github.com/twitter/ostrich">ostrich</a>.</p>

<p>Ostrich - это довольно развесистая библиотека, предназначенная для</p>

<ul>
<li>конфигурирования</li>
<li>сбора статистики</li>
<li>запуска/остановки приложения и его сервисов</li>
<li>предоставления админского интерфейса через HTTP или просто сокет</li>
</ul>


<p>Главная особенность конфиг-файлов ostrich - они являются обычными Scala-классами, со всемы вытекающими: они типизированы и могут наследоваться от абстрактного класса или трейта. В тех местах, где конфигурация используется, отпадает необходимость извлечения значений из конфига, проверки на то что они присутствуют, предоставления дефолтных значений и приведения к нужному типу. Обратной стороной медали можно было бы назвать необходимость компиляции конфига в рантайме, но поскольку делать это нужно не так уж часто (обычно при старте приложения), то ради красивых type-safe конфигов можно и потерпеть.</p>

<p>Также, ostrich предоставляет готовую заготовку ServerConfig, включающую в себя настройку логгинга и поднятие http/socket интерфейса при загрузке.</p>

<p>Несмотря на фичастость, мне кажется что автор configgy совершенно зря остановил развитие библиотеки: она очень проста в использовании и идеально подходит для большого диапазона проектов. Ostrich же относится к совершенно другой категории и для многих задач его навороченность выглядит излишней. Кроме того, в его использовании есть несколько подводных камней, о которых я постараюсь рассказать поподробнее в следующий раз.</p>
</div>
  <footer>
    <a rel="full-article" href="/blog/2011/08/23/scala-irl-1-configs/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/20/types-of-programmers/">Очередная классификация программистов</a></h1>
    
    
      <p class="meta">




<time datetime="2011-08-20 11:31:00 +0400" pubdate  updated >Aug 20<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Утром наткнулся в zite на замечательную статью: &#8221;<a href="http://techiferous.com/2011/08/are-you-a-good-programmer/">Are You a Good Programmer?</a>&#8221;, в которой приведена интересная классификация <em>хороших</em> программистов. Несмотря на всю относительность таких классификаций, очень занимательно примерять это всё на себя.</p>

<p>Мне трудно судить, являюсь ли я на данный момент действительно хорошим программистом (и каким критериям, собственно, надо для этого соответствовать?), но определённо могу сказать что последний год развиваюсь в сторону первого типа (Philosopher). Этому явно способствует и спользование такого языка как scala, склоняющая к очень &#8220;безопасному&#8221; стилю программирования, и позволяющая хорошо управлять ограничениями в коде с помощью системы типов, при этом сохраняя красоту и лаконичность кода.</p>

<p>Было бы интересно узнать, к какому типу вы себя относите? Понятно что типы могут сочетаться в разных пропорциях, и вполне возможно, что можно придумать ещё несколько.</p>
</div>
  <footer>
    <a rel="full-article" href="/blog/2011/08/20/types-of-programmers/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/15/">Ура! Новый хоумпейж!</a></h1>
    
    
      <p class="meta">




<time datetime="2011-08-15 11:19:00 +0400" pubdate  updated >Aug 15<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Уф, я кажется таки настроил <a href="http://octopress.org/" title="Octopress: A blogging framework for hackers.">octopress</a> и наверное таки останусь здесь.
Несмотря на излишнюю красноглазость (девиз октопресса говорит сам за себя) эта платформа ближе всего к идеалу блогдвижка, как я его представляю.
Как дойдут руки, я попробую доконфигурить это до юзабельного состояния (&#8220;ха-ха!&#8221; - как бы говорит линуксоедный опыт) и начать уже писать посты,
благо исчезает последняя отмазка этого не делать - отсутствие нормального блога.</p>

</div>
  <footer>
    <a rel="full-article" href="/blog/2011/08/15/">Read on &rarr;</a>
  </footer>


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/08/15/hello/">Hello?</a></h1>
    
    
      <p class="meta">




<time datetime="2011-08-15 11:15:00 +0400" pubdate  updated >Aug 15<span>th</span>, 2011</time>


</p>
    
  </header>


  <div class="entry-content"><p>Привет? Рас-рас!</p>
</div>
  <footer>
    <a rel="full-article" href="/blog/2011/08/15/hello/">Read on &rarr;</a>
  </footer>


  </article>

<nav role="pagination">
  <div>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'digal';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/09/25/squeryl/">Squeryl: основы</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/07/fixtures/">Fixtures</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/05/no-newsletters/">Пример хорошего UX</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/29/scala-irl-2-ostrich/">Scala IRL. Часть 2: Готовим Домашнего Страуса</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/23/scala-irl-1-configs/">Scala IRL. Часть 1: конфиги.</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("digal", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/digal" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @digal</a>
  
</section>



<section>
  <h1>Pet projects:</h1>
  <li><a href="http://digal.github.com/nerdometer">Nerd-o-meter</a> - статистика твиттер-клиентов.

  <h1>Work</h1>
  <li><a href="https://github.com/elegion/jdbc-mongo-migrator">SQL-MongoDB migration tool</a></li> - использовался для миграции базы goozy с MySQL в MongoDB и отлично справился с этим. 
  <li><a href="https://github.com/elegion/Scala-ZMQ-RPC">Scala-ØMQ-RPC</a> - простой ØMQ-RPC сервер (+ ещё более простой клиент) на Scala. База для одного из рабочих проектов, пока ни разу не production ready.
</section>

  
</aside>


    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Yuri Buyanov -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
</body>
</html>
